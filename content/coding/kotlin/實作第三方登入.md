---
title: Android - å¯¦ä½œç¬¬ä¸‰æ–¹ç™»å…¥
type: coding
category: Android
tags: [Kotlin]
description: ä¸€æ¬¡å­¸æœƒ Facebookã€Googleã€Line ç™»å…¥
date: '2020-02-11'
---

ä¹‹å‰ side-project æœ‰ç¨å¾®ç ”ç©¶ï¼Œæœ€è¿‘æ¡ˆå­éœ€æ±‚åˆé‡æ–°çœ‹äº†ä¸€æ¬¡ï¼Œä¹¾è„†æ•´ç†èµ·ä¾†ã€‚

æ•´é«”ä¾†èªªï¼Œ[Facebook ç¬¬ä¸‰æ–¹ç™»å…¥](#Facebookç°¡æ˜“ç™»å…¥åšæ³•)ç›¸å°å®¹æ˜“ï¼Œ[Google](#Googleç™»å…¥) å’Œ [LINE](#LINEç™»å…¥) å‰‡è¦èŠ±æ™‚é–“ç”³è«‹å¸³è™Ÿå’Œé©—è­‰ï¼Œéœ€è¦é€²è¡Œä¸å°‘æ­¥é©Ÿï¼Œç¶²è·¯ä¸Šè³‡æ–™å¾ˆå¤šï¼Œå°±æˆ‘è’é›†åˆ°æ¯”è¼ƒæ¸…æ¥šçš„éƒ¨åˆ†ä¾†å¯¦ä½œã€‚

---
---

### Facebookç°¡æ˜“ç™»å…¥åšæ³•
åƒè€ƒé€™ç¯‡ [Android å°ˆç”¨ Facebook ç™»å…¥](https://developers.facebook.com/docs/facebook-login/android?locale=zh_TW)ï¼ŒåŸºæœ¬ä¸ŠæŒ‰ç…§æ–‡ä»¶ä¸€æ­¥ä¸€æ­¥å°±å¯ä»¥å®Œæˆ

åœ¨ **XML** ä½¿ç”¨ï¼Œå·²åŒ…è£ LoginManager å¯ç”¨åŠŸèƒ½çš„ UI å…ƒä»¶
```java
 <com.facebook.login.widget.LoginButton
    android:id="@+id/btn_facebook_login"
    android:layout_width="300dp"
    android:layout_height="300dp"/>
```
**è¨»å†Š Callback**
åˆå§‹åŒ–æ™‚å»ºç«‹ CallbackManager
```java
lateinit var callbackManager: CallbackManager

override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)
    setContentView(R.layout.activity_login)
    
    //å»ºç«‹ CallbackManager
    callbackManager = CallbackManager.Factory.create()
...
```
åœ¨ onCreate() æˆ– onCreateView() æ–¹æ³•ä¸­è¨»å†Šå›å‘¼ï¼Œè‡ªå®šç¾© LoginButtonï¼Œç™»å…¥æˆåŠŸï¼ŒLoginResult åƒæ•¸æœƒå…·æœ‰æ–°çš„ AccessToken 
```java
loginButton.setReadPermissions("email")
    
    // å¦‚æœåœ¨ fragment ä¸­ä½¿ç”¨
    loginButton.setFragment(this)
    
    // è¨»å†Šå›å‘¼
    btn_facebook_login.registerCallback(callbackManager,
        object : FacebookCallback<LoginResult> {
            override fun onSuccess(result: LoginResult?) {
                // å–å¾— token å’Œ userID
                val token = result!!.accessToken.token.toString()
                val userId = result.accessToken.userId.toString()
            }
            override fun onCancel() {
            }
            override fun onError(error: FacebookException?) {
            }
        })
```
è¦åœ¨ onActivityResult æ–¹å¼ä¸­å‘¼å« callbackManager.onActivityResultï¼Œæ‰å¯ä»¥å¾ LoginManager å–å¾—çµæœ
```java
override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
    super.onActivityResult(requestCode, resultCode, data)
        
        //callbackManager æœƒå°‡ç™»å…¥çµæœå‚³é€è‡³ LoginManager
        callbackManager.onActivityResult(requestCode, resultCode, data)
}
```
**<å°šæœªä½¿ç”¨é>**
ä½¿ç”¨ SDK å¾å¿«å–æˆ–æ‡‰ç”¨ç¨‹å¼æ›¸ç±¤è¼‰å…¥ 
* AccessToken.getCurrentAccessToken
* Profile.getCurrentProfile()

åœ¨ç¨‹å¼é‡æ–°å•Ÿå‹•æ™‚ï¼Œæ–¼ Activity çš„ `onCreate` æ–¹æ³•ä¸­å…ˆæª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ã€æ˜¯å¦ä»å…·æœ‰æ•ˆæ€§
```java
val accessToken = AccessToken.getCurrentAccessToken()
val isLoggedIn: boolean = accessToken != null && !accessToken.isExpired()
```
ä¹‹å¾Œä¾¿å¯åŸ·è¡Œå¯¦éš›ç™»å…¥ï¼Œä¾‹å¦‚å¯«åœ¨è‡ªè¨‚æŒ‰éˆ•çš„ `OnClickListener` ä¸­
```java
LoginManager.getInstance().logInWithReadPermissions(this, Arrays.asList("public_profile"));
```
---

### Googleç™»å…¥
æµç¨‹æ»¿å¤šï¼Œæœƒæœ‰é»è¤‡é›œï¼Œå¯ä»¥åƒè€ƒä¸‹é¢å…©ç¯‡ï¼Œå‰é¢çš„é…ç½®å°±ç•¥éï¼Œç­†è¨˜ä¸€ä¸‹æ­¥é©Ÿ

1. **XML**è£¡é¢æ”¾ Google ç™»å…¥æŒ‰éˆ•ï¼Œ åªæœ‰æä¾›ç™»å…¥ã€æ²’æœ‰ç™»å‡ºæŒ‰éˆ•...åªå¥½è‡ªå·±åˆ»ä¸€å€‹
```java
<com.google.android.gms.common.SignInButton
    android:id="@+id/btn_google_login"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"/>
```

2. åœ¨`build.gradle` implement
```java
dependencies {
    ...
    implementation 'com.google.android.gms:play-services-auth:17.0.0'
    ...
} 
```
3. é€™éƒ¨åˆ†å¯¦ä½œä¸»è¦æ˜¯åƒè€ƒé€™ä»½[å®˜æ–¹æ–‡ä»¶](https://developers.google.com/identity/sign-in/android/sign-in#add_the_google_sign-in_button_to_your_app)ï¼Œå¾—å…ˆå» [Goodle APIs](https://console.developers.google.com/api) æ–°å¢å°ˆæ¡ˆï¼Œå¦‚æœä½ å°ˆæ¡ˆå¼„å¥½ã€å»å¿˜äº†é…ç½®ä¸€äº›è³‡è¨Šï¼Œåœ¨ [Try Sign-In for Android](https://developers.google.com/identity/sign-in/android/start-integrating)è£œä¸Š
![](https://i.imgur.com/xzksyPl.png)

é…ç½® Google API project
![](https://i.imgur.com/9337nui.png)

è¦å¡«å…¥åŒ…åå’ŒSHA-1ï¼Œå®Œæˆé€™å…©å€‹æ‰æœƒæ‹¿åˆ° **Client ID**ï¼Œæœ‰å®ƒæ‰èƒ½å–å¾— Token å‘€ï¼
* åŒ…å(Package Name) åœ¨ `build.gradle` æ‰¾
* SHA-1 å€¼

![](https://i.imgur.com/XfpEgs6.png)

#### å¦‚ä½•å–å¾— SHA-1 å€¼
ä¸ä¸€å®šè¦è¼¸å…¥æŒ‡ä»¤ï¼Œåªè¦åœ¨ Android Studio å³å´é»é¸ `Tasks -> Android -> SigningResport`å°±æœƒå‡ºç¾å›‰

![](https://i.imgur.com/kgVYTgS.png)

![](https://i.imgur.com/xwjwOrK.png)

---

4. æ‹¿åˆ° Client ID ä¹‹å¾Œå°±å¯ä»¥å›åˆ°ç¨‹å¼ç¢¼ï¼Œç™»å…¥è¨­ç½®å¦‚ä¸‹ï¼Œå°±æ˜¯å¡«å…¥ "serverClientId"

```java
//Googleç™»å…¥
private fun google_login(){
    //å»ºç«‹ GoogleSignInOptions
    val mGoogleSignInOptions = GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)
        .requestServerAuthCode("serverClientId")
        .requestIdToken("serverClientId")
        .requestEmail()
        .build()
    val mgoogleApiClient = GoogleApiClient
        .Builder(this)
        .addApi(Auth.GOOGLE_SIGN_IN_API, mGoogleSignInOptions)
        .build()
    val signInIntent= Auth.GoogleSignInApi.getSignInIntent(mgoogleApiClient)
    startActivityForResult(signInIntent, REQ_GOOGLE_LOGI)
}
```

æˆ‘æä¸æ¸…æ¥š requestServerAuthCode å’Œ requestIdToken å·®åœ¨å“ªè£¡ï¼ŒæŸ¥äº†ä¸€ä¸‹æ‰çŸ¥é“ï¼Œ[åƒè€ƒ](https://stackoverflow.com/questions/39668773/what-is-diff-between-requestidtoken-and-requestserverauthcode-in-google-singnin)

```java
//Googleç™»å‡º
private fun google_logOut() {
    val gso = GoogleSignInOptions
        .Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)
        .requestIdToken("serverClientId")
        .requestEmail()
        .build()
    mGoogleSignInClient = GoogleSignIn.getClient(this, gso)
    mGoogleSignInClient.signOut()
}
```

æ¥æ”¶ Google å›å‚³çµæœ

```java
override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
    super.onActivityResult(requestCode, resultCode, data)

    if (requestCode == REQ_GOOGLE_LOGIN && data != null) {
        val task = GoogleSignIn.getSignedInAccountFromIntent(data)
        handleGoogleResult(task)
}

//è§£ægoogleå›å‚³çµæœ
private fun handleGoogleResult(task: Task<GoogleSignInAccount>) {
    val account = task.getResult(ApiException::class.java)
    val getEmail = account!!.email
    val getidToken = account.idToken
    //ç”±å¾Œç«¯å»é©—è­‰token
}
```
---

#### Googleç™»å…¥å•é¡Œ
- **`com.google.android.gms.common.api.ApiExceptionï¼š10` æä¾›æœªçŸ¥çš„å®¢æˆ·ç«¯ID**

å‡ºç¾ `10` éŒ¯èª¤ç‚ºé…ç½®ä¸æ­£ç¢ºï¼Œè¡¨ç¤ºç‚ºé–‹ç™¼äººå“¡çš„éŒ¯èª¤ï¼Œå¯èƒ½æ²’æœ‰æä¾› SHA-1 æˆ–æ˜¯æœªå›æ‡‰å° idToken çš„è«‹æ±‚ï¼Œæª¢æŸ¥ `requestIdToken(getString(R.string.google_app_id))` æœ‰ç„¡æ­£ç¢ºå¡«å…¥ã€‚

- **`com.google.android.gms.common.api.ApiExceptionï¼š12500`**
ä¸€ç›´å‡ºç¾ `12500` éŒ¯èª¤ï¼Œé€™å€‹çœŸçš„å¾ˆé›£åµéŒ¯åŸå› ï¼ŒèŠ±äº†å¿«å…©å€‹å°æ™‚æ‰æ‰¾åˆ°å•é¡Œè§£ç­”ï¼Œåƒè€ƒé€™ç¯‡ [error 12500 in google sign in](https://stackoverflow.com/questions/34068065/error-12500-in-google-sign-in-8-3-0-when-requesting-requestserverauthcode) æˆ– [android:Firebase Google Authç„¡æ³•ä½¿ç”¨ ApiExceptionï¼š12500](https://t.codebug.vip/questions-1254036.htm)ï¼Œç¶²ä¸Šçœ¾èªªç´›ç´œï¼Œç™¼ç¾è‡ªå·±æ˜¯å› ç‚ºå…©ç¨®éŒ¯èª¤è€Œé€ æˆï¼š

---

**Web Client ID** å‡ºéŒ¯

1. æ‰“é–‹ [Google API Console](https://console.developers.google.com/apis/) å·¦ä¸Šè§’**é¸æ“‡å°ˆæ¡ˆ**
2. æŒ‰å·¦å´ã€Œæ†‘è­‰ã€ï¼Œæœƒçœ‹åˆ° OAuth 2.0 ç”¨æˆ¶ç«¯ ID
3. ç¢ºä¿ä½ åœ¨ `requestServerAuthCode` æ–¹æ³•è£¡å¡«å…¥çš„æ˜¯ **Web Client Id**ï¼Œè€Œä¸æ˜¯ Android

åŸå› å‡ºåœ¨è¼¸å…¥ SHA1 å¾Œæœƒç”¢ç”Ÿ **Android** å’Œ **webclient** å…©å€‹ Client IDï¼š
a SHA1 code created both an Android oauth client and a webclient in google developers console.


![](https://i.imgur.com/pMGwlBa.png)

---

**ä¸åŒçš„é™¤éŒ¯ SHA1-key** å‡ºéŒ¯
æ‰¾äº†å¥½ä¹…æ‰ç™¼ç¾ android æœƒç”Ÿæˆä¸åŒçš„ SHA1 å€¼ï¼Œå› ç‚ºæˆ‘æ‰“åŒ…ç”¨çš„æ˜¯ release modeï¼Œä½†æ˜¯ä¸€ç›´å¡«åˆ° debug çš„ SHA1-key...

![](https://i.imgur.com/AYVt6FR.png)


---

### LINEç™»å…¥
Line ç™»å…¥å¯¦ä½œç¶²è·¯ä¸Šè³‡æ–™ä¸å¤šï¼Œæœ€å¥½å°±æ˜¯ç›´æ¥åƒè€ƒ[å®˜æ–¹ä½œæ³•](https://developers.line.biz/en/docs/android-sdk/integrate-line-login/#add-line-sdk-dependency)
1. åœ¨ `build.gradle` æ·»åŠ  LINE SDK

```java
repositories {
   ...
   jcenter()
}

dependencies {
    ...
    implementation 'com.linecorp:linesdk:5.0.1'
    ...
} 
```

æ·»åŠ  Android ç·¨è­¯é …ç›®ï¼Œå¯ä½¿ç”¨`Java 1.8 support`

```java
android {
...
  compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
...
}
```

2. å» `manifest` åŠ å…¥ç¶²è·¯æ¬Šé™

```java
<uses-permission android:name="android.permission.INTERNET" />
```
3. è¨­å®šæª”å¥½äº†å¾Œï¼Œæ¥è‘—åœ¨ [LINE Developer](https://developers.line.biz/zh-hant/?status=success) ç™»å…¥ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç™»å°±è¦è¨»å†Šé–‹ç™¼è€…ï¼Œç™»å…¥å¾Œé ˆå»ºç«‹ä¸€å€‹ Providerï¼Œåƒæ˜¯ APP é–‹ç™¼åœ˜éšŠæˆ–å…¬å¸åç¨±ï¼Œè·Ÿå€‹äººè³‡è¨Šç„¡é—œçš„ã€‚
4. ç„¶å¾Œåœ¨ä½ å»ºç«‹çš„ Provider ä¸­ï¼Œæ–°å¢ä¸€å€‹é »é“(channel)ï¼Œæœƒå‡ºç¾ä¸€å€‹åƒåŠŸèƒ½åˆ—çš„é¸å–®ï¼Œå°±æ˜¯é€™æ”¯é »é“æ˜¯ç”¨ä¾†åšä»€éº¼çš„ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯è¦ç”¨ç¬¬ä¸‰æ–¹ç™»å…¥å°±é¸ **LINE Login**

![](https://i.imgur.com/QUfLcZo.png)

5. åŸºæœ¬è¦å¡«çš„å°±æ˜¯ Channel nameã€Channel descriptionã€Emailã€€ä¸‰é …ï¼Œç„¶å¾Œå»è¨­å®š(LINE Login)é¸æ“‡ **Mobile APP**ï¼Œå¡«å…¥åŒ…è£¹åç¨±
 
![](https://i.imgur.com/9SwgPdL.png)

ä¹Ÿå°±æ˜¯ `build.gradle` è£¡é¢çš„ã€€**applicationId**

![](https://i.imgur.com/fhavrwO.png)

å¦‚æœé‚„ä¸å¤ªç†è§£ï¼Œå¯ä»¥åœ¨ [Getting started with the Messaging API](https://developers.line.biz/en/docs/messaging-api/getting-started/#creating-a-channel) æŸ¥çœ‹æ­¥é©Ÿï¼Œå¡«å®Œé€™äº›ä½ å°±å¯ä»¥å¾—åˆ° Channel ID å’Œ Channel secret ç­‰è³‡æ–™ï¼Œç­‰ä¸‹å‰è€…æ˜¯è¦ç”¨ä¾†è¨­ç½®åƒæ•¸çš„ã€‚

---
å‰ç½®ä½œæ¥­å®Œæˆäº†ï¼Œä¾†å¯¦ä½œç¨‹å¼ç¢¼çš„éƒ¨åˆ†ï¼Œåœ¨ XML ä¸Šæ–°å¢ä¸€å€‹æŒ‰éˆ•ï¼Œå› ç‚º LINE æœ‰æä¾›å…§å»ºçš„ç™»å…¥æŒ‰éˆ•ï¼Œé€™è£¡å°±ç›´æ¥ä½¿ç”¨ï¼š
```java
<com.linecorp.linesdk.widget.LoginButton
    android:id="@+id/line_login_btn"
    android:layout_width="match_parent"
    android:layout_height="wrap_content" />
```
å¤§æ¦‚é•·é€™å€‹æ¨£å­
![](https://i.imgur.com/ozwNiHX.png)

Activity çš„éƒ¨åˆ†ï¼Œç‚º LINE ç™»å…¥æŒ‰éˆ•è¨­ç½®å¿…è¦çš„åƒæ•¸ã€ç›£è½å™¨ï¼Œæ¯”è¼ƒæ³¨æ„çš„æ˜¯
```java
//LINEç™»å…¥æŒ‰éˆ•è¨­å®š
lateinit var params: LineAuthenticationParams
...
private fun setLineLogin(){
    val loginDelegate = LoginDelegate.Factory.create()
    
    //æ”¾å…¥ChannelId å­—ä¸²
    btn_line_login.setChannelId("1653832701")
    //æ˜¯å¦åªé€éLINE APPï¼Œæˆ–å¯ä»¥é€éç¶²é 
    btn_line_login.enableLineAppAuthentication(true)
    //params å¯«ç™»å…¥å¾Œè«‹æ±‚çš„æ¬Šé™ç¯„åœ
    params = LineAuthenticationParams.Builder()
        .scopes(Arrays.asList(Scope.PROFILE))
        .build()
    
    //LoginæŒ‰éˆ•åƒæ•¸å’Œç›£è½å™¨
    btn_line_login.setAuthenticationParams(params)
    btn_line_login.setLoginDelegate(loginDelegate)
    btn_line_login.addLoginListener(object: LoginListener{
        override fun onLoginSuccess(result: LineLoginResult) {
            Toast.makeText(this@MainActivity, "Login success", Toast.LENGTH_SHORT).show()
        }
        override fun onLoginFailure(result: LineLoginResult?) {
            Toast.makeText(this@MainActivity, "Login failure", Toast.LENGTH_SHORT).show();
        }
    })
}
```
**ğŸ””é–‹å§‹ LINE ç™»éŒ„**
é€™è£¡å¯ä»¥æœ‰å…©ç¨®å¯«æ³•ï¼Œé¸æ“‡å°å…¥ LINE APP æˆ–æ˜¯ç›´æ¥é–‹å•Ÿ WebViewï¼Œä¹‹å¾Œæœ‰ç©ºè£œä¸Šé‚è¼¯ï¼Œè‡ªå‹•åˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦æœ‰è£ä¸ŠæŸæ‡‰ç”¨ç¨‹å¼
```java
//ä½¿ç”¨æ‡‰ç”¨ç¨‹åºç™»å…¥ #1
btn_line_login.setOnClickListener{
    val loginIntent = LineLoginApi.getLoginIntent(this, "1653832701", params)
    startActivityForResult(loginIntent, REQ_LINE_CODE)
}
//ç€è¦½å™¨çš„LINEç™»å…¥ #2
btn_line_login.setOnClickListener{
    val loginIntent = LineLoginApi.getLoginIntentWithoutLineAppAuth(this, "1653832701", params)
    startActivityForResult(loginIntent, REQ_LINE_CODE)
}
```
æ¥æ”¶ LINE ç™»å…¥å›å‚³çµæœï¼Œä»¥ `onActivityResult()` æ–¹æ³•è¿”å›ï¼Œå¯å–å¾—ç”¨æˆ¶è³‡è¨Šå’Œ **Token**
```java
override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
    super.onActivityResult(requestCode, resultCode, data)

    if (requestCode == REQ_LINE_CODE && data != null){
    val result = LineLoginApi.getLoginResultFromIntent(data)
    when (result.responseCode) {
        //å›æ‡‰æˆåŠŸ
        LineApiResponseCode.SUCCESS -> {
            val userId = result.lineProfile!!.userId
            val displayName = result.lineProfile!!.displayName
            val accessToken = result.getLineCredential()!!.getAccessToken().getTokenString()
        }
        //å›æ‡‰å¤±æ•—
        LineApiResponseCode.CANCEL -> {
            Log.e("ljwx-line-cancel-", "cancel")
        }
        else -> {
            return
        }
    }
}
```